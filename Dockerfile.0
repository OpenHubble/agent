# Use a lightweight Python image
FROM python:3.10-alpine

# Set environment variables for predictable builds
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Install build dependencies and upgrade pip
RUN apk add --no-cache --virtual .build-deps \
    gcc \
    libc-dev \
    libffi-dev \
    musl-dev \
    && apk add --no-cache \
    libffi \
    && python -m ensurepip --upgrade \
    && pip install --no-cache-dir --upgrade pip setuptools wheel

# Set working directory
WORKDIR /app

# Create and activate a virtual environment in .venv
RUN python -m venv /app/.venv

# Ensure all future commands use the .venv environment
ENV PATH="/app/.venv/bin:$PATH"

# Copy only the necessary files for dependency installation first
COPY requirements.txt /app/

# Install dependencies in the virtual environment
RUN pip install --no-cache-dir -r requirements.txt

# Copy the rest of the application files
COPY . /app

# Expose volumes for /proc and /sys (optional, not usually needed for apps)
VOLUME ["/proc", "/sys"]

# Set the default command to run the application
CMD ["python", "main.py"]
